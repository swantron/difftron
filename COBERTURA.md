# Cobertura XML Format Support

Difftron supports Cobertura XML format coverage reports, commonly used by Java, Python, JavaScript, and other language test frameworks.

## Overview

Cobertura is an XML-based coverage format that provides detailed line and branch coverage information. Difftron automatically detects and parses Cobertura XML files alongside LCOV and Go coverage formats.

## Supported Tools

Cobertura XML format is generated by many popular testing tools:

### Java
- **JaCoCo** (with Cobertura plugin)
- **Cobertura** (native)
- **Gradle** (with Cobertura plugin)
- **Maven** (with Cobertura plugin)

### Python
- **pytest-cov** (with `--cov-report=xml:cobertura.xml`)
- **coverage.py** (with `coverage xml --format=cobertura`)

### JavaScript/TypeScript
- **nyc** (with `--reporter=cobertura`)
- **jest** (with `jest-coverage-report` plugin)
- **c8** (with `--reporter=cobertura`)

### .NET
- **Coverlet** (with `--format cobertura`)
- **OpenCover** (with Cobertura converter)

## Usage

### Basic Usage

```bash
# Analyze with Cobertura XML file
difftron analyze --coverage coverage.xml

# Difftron automatically detects Cobertura format
difftron analyze --coverage cobertura.xml --threshold 80
```

### CI/CD Integration

#### GitHub Actions

```yaml
- name: Run tests with Cobertura coverage
  run: |
    pytest --cov=src --cov-report=xml:cobertura.xml
    # or
    npm test -- --coverage --coverageReporters=cobertura

- name: Analyze coverage
  run: |
    difftron ci --threshold 80 cobertura.xml
```

#### GitLab CI

```yaml
test-with-coverage:
  stage: test
  script:
    - pytest --cov=src --cov-report=xml:cobertura.xml
  artifacts:
    paths:
      - cobertura.xml

difftron-analysis:
  stage: coverage
  dependencies:
    - test-with-coverage
  script:
    - ./vendor/difftron/difftron ci --threshold 80 cobertura.xml
```

## Cobertura XML Format

Cobertura XML files have the following structure:

```xml
<?xml version="1.0"?>
<!DOCTYPE coverage SYSTEM "http://cobertura.sourceforge.net/xml/coverage-04.dtd">
<coverage line-rate="0.5" branch-rate="0.5" lines-covered="10" lines-valid="20">
  <sources>
    <source>/path/to/source</source>
  </sources>
  <packages>
    <package name="com.example" line-rate="0.5">
      <classes>
        <class name="MyClass" filename="src/com/example/MyClass.java" line-rate="0.5">
          <lines>
            <line number="10" hits="5"/>
            <line number="11" hits="3"/>
            <line number="12" hits="0"/>
          </lines>
        </class>
      </classes>
    </package>
  </packages>
</coverage>
```

### Key Elements

- **`<coverage>`**: Root element with overall coverage statistics
- **`<sources>`**: Source code paths for resolving relative file paths
- **`<packages>`**: Package-level organization
- **`<classes>`**: Class-level coverage data
- **`<lines>`**: Line-by-line coverage information
- **`<line>`**: Individual line with `number` (line number) and `hits` (execution count)

## Format Detection

Difftron automatically detects Cobertura format by checking for:
1. XML declaration (`<?xml`)
2. `<coverage>` root element
3. Cobertura-specific elements (`<package>`, `<class>`)

Detection happens automatically - no need to specify the format:

```bash
# These all work automatically
difftron analyze --coverage coverage.xml      # Cobertura XML
difftron analyze --coverage coverage.info     # LCOV format
difftron analyze --coverage coverage.out      # Go format
```

## Path Resolution

Cobertura XML files may contain relative file paths. Difftron resolves these paths using:

1. **Direct match**: If the filename matches a source path exactly
2. **Source path resolution**: Combines source paths from `<sources>` with relative filenames
3. **Normalization**: Normalizes paths for cross-platform compatibility

### Example

```xml
<sources>
  <source>/home/user/project/src</source>
</sources>
<classes>
  <class filename="com/example/MyClass.java" ...>
```

Difftron will resolve this to: `/home/user/project/src/com/example/MyClass.java`

## Examples

### Python with pytest-cov

```bash
# Generate Cobertura XML
pytest --cov=src --cov-report=xml:cobertura.xml

# Analyze with Difftron
difftron analyze --coverage cobertura.xml --threshold 80
```

### JavaScript with nyc

```bash
# Generate Cobertura XML
nyc --reporter=cobertura npm test

# Analyze with Difftron
difftron analyze --coverage coverage/cobertura-coverage.xml --threshold 80
```

### Java with Gradle

```bash
# Generate Cobertura XML (with plugin)
./gradlew test jacocoTestReport
# Convert JaCoCo to Cobertura if needed

# Analyze with Difftron
difftron analyze --coverage build/reports/jacoco/test/jacocoTestReport.xml --threshold 80
```

### Multi-Language Project

```bash
# Python tests
pytest --cov=python/src --cov-report=xml:python-coverage.xml

# JavaScript tests
nyc --reporter=cobertura npm test -- --coverage

# Analyze both (if using holistic health feature)
difftron health \
  --unit-coverage python-coverage.xml \
  --api-coverage js-coverage.xml \
  --threshold 80
```

## Troubleshooting

### File Path Mismatches

If Difftron can't match git diff paths with Cobertura file paths:

1. **Check source paths**: Ensure `<sources>` elements contain correct paths
2. **Check filename attributes**: Verify `filename` attributes in `<class>` elements
3. **Use path normalization**: Difftron automatically normalizes paths, but check for:
   - Absolute vs relative paths
   - Windows vs Unix path separators
   - Different working directories

### Missing Coverage Data

If coverage seems incomplete:

1. **Check line elements**: Ensure `<lines>` sections contain all executable lines
2. **Verify hit counts**: Lines with `hits="0"` are considered uncovered
3. **Check class-level vs method-level**: Difftron prefers class-level `<lines>` but also checks method-level

### Format Detection Issues

If Difftron doesn't detect Cobertura format:

1. **Check XML structure**: Ensure file starts with `<?xml` and has `<coverage>` root
2. **Verify Cobertura elements**: File should contain `<package>` or `<class>` elements
3. **Check file extension**: While not required, `.xml` extension helps detection

## Comparison with Other Formats

| Feature | Cobertura | LCOV | Go Coverage |
|---------|-----------|------|-------------|
| Format | XML | Text | Binary/Text |
| Line Coverage | ✅ | ✅ | ✅ |
| Branch Coverage | ✅ | ✅ | ❌ |
| Method Coverage | ✅ | ❌ | ✅ |
| File Path Resolution | ✅ | ✅ | ✅ |
| Multi-Language | ✅ | ✅ | ❌ (Go only) |

## Best Practices

1. **Use consistent source paths**: Keep `<sources>` paths consistent across builds
2. **Include all executable lines**: Ensure coverage reports include all lines, not just covered ones
3. **Normalize paths**: Use relative paths when possible for portability
4. **Combine with other formats**: Use holistic health analysis to combine Cobertura with other test types

## Additional Resources

- [Cobertura XML DTD](http://cobertura.sourceforge.net/xml/coverage-04.dtd)
- [Cobertura Documentation](https://cobertura.github.io/cobertura/)
- [Difftron Documentation](README.md)
- [Holistic Health Analysis](HOLISTIC_HEALTH.md)
