name: Difftron Quality Gate

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  analyze:
    name: Analyze Coverage
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for git diff

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install dependencies
        run: go mod download

      - name: Run tests with coverage
        run: |
          go test -coverprofile=coverage.out ./...
          go tool cover -func=coverage.out > coverage.txt

      - name: Build difftron
        run: go build -o bin/difftron ./cmd/difftron

      - name: Get diff base
        id: diff-base
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "base=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
          else
            echo "base=${{ github.event.before }}" >> $GITHUB_OUTPUT
          fi

      - name: Analyze coverage
        id: analyze
        run: |
          # Generate git diff
          git diff ${{ steps.diff-base.outputs.base }}..${{ github.sha }} > diff.patch || true
          
          # Run difftron analysis
          ./bin/difftron analyze \
            --coverage coverage.out \
            --diff diff.patch \
            --threshold 80 \
            --output json > analysis.json || true
          
          # Also get text output for comment
          ./bin/difftron analyze \
            --coverage coverage.out \
            --diff diff.patch \
            --threshold 80 \
            --output text > analysis.txt || true
          
          # Extract coverage percentage
          COVERAGE=$(jq -r '.coverage_percentage // 0' analysis.json 2>/dev/null || echo "0")
          MEETS_THRESHOLD=$(jq -r '.meets_threshold // false' analysis.json 2>/dev/null || echo "false")
          
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "meets_threshold=$MEETS_THRESHOLD" >> $GITHUB_OUTPUT

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const analysis = fs.readFileSync('analysis.txt', 'utf8');
            const analysisJson = JSON.parse(fs.readFileSync('analysis.json', 'utf8'));
            
            const coverage = analysisJson.coverage_percentage || 0;
            const threshold = 80;
            const emoji = coverage >= threshold ? '✅' : '❌';
            
            const body = `## ${emoji} Difftron Coverage Analysis
            
**Coverage:** ${coverage.toFixed(1)}% (threshold: ${threshold}%)
**Status:** ${coverage >= threshold ? 'PASS' : 'FAIL'}

<details>
<summary>Detailed Report</summary>

\`\`\`
${analysis}
\`\`\`

</details>

### Summary
- **Total Changed Lines:** ${analysisJson.total_changed_lines || 0}
- **Covered Lines:** ${analysisJson.covered_lines || 0}
- **Uncovered Lines:** ${analysisJson.uncovered_lines || 0}
`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Set status check
        if: github.event_name == 'push'
        run: |
          COVERAGE="${{ steps.analyze.outputs.coverage }}"
          MEETS_THRESHOLD="${{ steps.analyze.outputs.meets_threshold }}"
          
          if [ "$MEETS_THRESHOLD" == "true" ]; then
            echo "✅ Coverage check passed: ${COVERAGE}%"
            exit 0
          else
            echo "❌ Coverage check failed: ${COVERAGE}% (threshold: 80%)"
            exit 1
          fi

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.out
            coverage.txt
            analysis.json
            analysis.txt
