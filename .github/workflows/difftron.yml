name: Difftron Quality Gate

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      threshold:
        description: 'Coverage threshold percentage'
        required: false
        default: '80'
        type: string

jobs:
  analyze:
    name: Analyze Coverage
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install dependencies
        run: go mod download

      - name: Run tests with coverage
        continue-on-error: true
        run: |
          # Run tests and capture coverage, ignoring tool errors
          go test -coverprofile=coverage.out ./... 2>&1 | grep -v "go: no such tool" || true
          
          # Ensure coverage.out exists
          if [ ! -f coverage.out ] || [ ! -s coverage.out ]; then
            echo "Warning: coverage.out is missing or empty, creating minimal file"
            echo "mode: set" > coverage.out
          fi
          
          # Verify coverage file is valid
          if ! head -1 coverage.out | grep -q "mode:"; then
            echo "Warning: coverage.out doesn't look like a valid Go coverage file"
          fi

      - name: Build difftron
        run: go build -o bin/difftron ./cmd/difftron

      - name: Set threshold
        id: threshold
        run: |
          # Get threshold from workflow input, PR label, or default to 80
          THRESHOLD="${{ github.event.inputs.threshold }}"
          if [ -z "$THRESHOLD" ]; then
            THRESHOLD="80"
          fi
          
          # For PRs, check for threshold in labels (e.g., "coverage-threshold:90")
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            LABELS="${{ toJson(github.event.pull_request.labels.*.name) }}"
            if echo "$LABELS" | grep -q "coverage-threshold:"; then
              LABEL_THRESHOLD=$(echo "$LABELS" | grep -o "coverage-threshold:[0-9]*" | cut -d: -f2 | head -1)
              if [ -n "$LABEL_THRESHOLD" ]; then
                THRESHOLD="$LABEL_THRESHOLD"
              fi
            fi
          fi
          
          echo "threshold=$THRESHOLD" >> $GITHUB_OUTPUT
          echo "Using coverage threshold: $THRESHOLD%"

      - name: Run difftron CI analysis
        id: difftron
        continue-on-error: true
        run: |
          if [ ! -f coverage.out ]; then
            echo "Error: coverage.out not found"
            exit 1
          fi
          
          THRESHOLD="${{ steps.threshold.outputs.threshold }}"
          
          # Run analysis - this will exit 1 if threshold not met, but we continue
          ./bin/difftron ci \
            --threshold "$THRESHOLD" \
            --output-file analysis.json \
            coverage.out 2>&1 || {
            EXIT_CODE=$?
            echo "Difftron analysis completed with exit code $EXIT_CODE"
            # Create fallback JSON if analysis fails completely
            if [ ! -f analysis.json ]; then
              echo "{\"coverage_percentage\": 0, \"threshold\": $THRESHOLD, \"meets_threshold\": false, \"total_changed_lines\": 0, \"covered_lines\": 0, \"uncovered_lines\": 0, \"files\": {}}" > analysis.json
            fi
            # Store exit code for later step
            echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          }
          
          # Extract whether threshold was met from JSON (more reliable than exit code)
          if [ -f analysis.json ]; then
            MEETS_THRESHOLD=$(jq -r '.meets_threshold // false' analysis.json 2>/dev/null || echo "false")
            COVERAGE=$(jq -r '.coverage_percentage // 0' analysis.json 2>/dev/null || echo "0")
            echo "meets_threshold=$MEETS_THRESHOLD" >> $GITHUB_OUTPUT
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          else
            echo "meets_threshold=false" >> $GITHUB_OUTPUT
            echo "coverage=0" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          GITHUB_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_BASE_REF: ${{ github.event.pull_request.base.ref }}
          GITHUB_EVENT_BEFORE: ${{ github.event.before }}

      - name: Comment on Pull Request
        if: github.event_name == 'pull_request' && always() && steps.difftron.outcome != 'skipped'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            let analysis = {
              coverage_percentage: 0,
              meets_threshold: false,
              total_changed_lines: 0,
              covered_lines: 0,
              uncovered_lines: 0,
              files: {}
            };
            
            try {
              if (fs.existsSync('analysis.json')) {
                analysis = JSON.parse(fs.readFileSync('analysis.json', 'utf8'));
              }
            } catch (error) {
              console.log('Error reading analysis.json:', error);
            }
            
            const coverage = analysis.coverage_percentage || 0;
            const threshold = analysis.threshold || 80;
            const emoji = coverage >= threshold ? '✅' : '❌';
            const status = coverage >= threshold ? 'PASS' : 'FAIL';
            
            // Check for existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Difftron Coverage Analysis')
            );
            
            let filesSummary = '';
            if (analysis.files && Object.keys(analysis.files).length > 0) {
              filesSummary = '\n### Files\n';
              for (const [file, data] of Object.entries(analysis.files)) {
                filesSummary += `- **${file}**: ${data.coverage_percentage.toFixed(1)}% coverage`;
                if (data.uncovered_line_numbers && data.uncovered_line_numbers.length > 0) {
                  filesSummary += ` (uncovered lines: ${data.uncovered_line_numbers.join(', ')})`;
                }
                filesSummary += '\n';
              }
            }
            
            const body = '## ' + emoji + ' Difftron Coverage Analysis\n\n' +
              '**Coverage:** ' + coverage.toFixed(1) + '% (threshold: ' + threshold + '%)\n' +
              '**Status:** ' + status + '\n\n' +
              '### Summary\n' +
              '- **Total Changed Lines:** ' + (analysis.total_changed_lines || 0) + '\n' +
              '- **Covered Lines:** ' + (analysis.covered_lines || 0) + '\n' +
              '- **Uncovered Lines:** ' + (analysis.uncovered_lines || 0) + '\n' +
              filesSummary +
              '\n---\n' +
              '*This comment is automatically updated on each push to the PR.*';
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Create Check Run
        if: github.event_name == 'pull_request' && always() && steps.difftron.outcome != 'skipped'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let analysis = { coverage_percentage: 0, meets_threshold: false };
            
            try {
              if (fs.existsSync('analysis.json')) {
                analysis = JSON.parse(fs.readFileSync('analysis.json', 'utf8'));
              }
            } catch (error) {
              // Use defaults
            }
            
            const coverage = analysis.coverage_percentage || 0;
            const threshold = analysis.threshold || 80;
            const conclusion = coverage >= threshold ? 'success' : 'failure';
            const title = coverage >= threshold 
              ? `Coverage check passed: ${coverage.toFixed(1)}%`
              : `Coverage check failed: ${coverage.toFixed(1)}% (threshold: ${threshold}%)`;
            
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Difftron Coverage',
              head_sha: context.payload.pull_request.head.sha,
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: title,
                summary: `Coverage: ${coverage.toFixed(1)}% | Changed Lines: ${analysis.total_changed_lines || 0} | Covered: ${analysis.covered_lines || 0} | Uncovered: ${analysis.uncovered_lines || 0}`
              }
            });

      - name: Gate PRs if threshold not met
        if: always() && github.event_name == 'pull_request' && steps.difftron.outcome != 'skipped'
        run: |
          # Read from JSON file (most reliable)
          if [ -f analysis.json ]; then
            MEETS_THRESHOLD=$(jq -r '.meets_threshold // false' analysis.json 2>/dev/null || echo "false")
            COVERAGE=$(jq -r '.coverage_percentage // 0' analysis.json 2>/dev/null || echo "0")
            THRESHOLD=$(jq -r '.threshold // 80' analysis.json 2>/dev/null || echo "80")
          else
            # Fallback to step outputs
            MEETS_THRESHOLD="${{ steps.difftron.outputs.meets_threshold }}"
            COVERAGE="${{ steps.difftron.outputs.coverage }}"
            THRESHOLD="${{ steps.threshold.outputs.threshold }}"
          fi
          
          echo "Coverage: ${COVERAGE}% | Threshold: ${THRESHOLD}% | Meets Threshold: ${MEETS_THRESHOLD}"
          
          if [ "$MEETS_THRESHOLD" != "true" ]; then
            echo "❌ Coverage threshold not met!"
            echo "Coverage: ${COVERAGE}% is below threshold: ${THRESHOLD}%"
            echo "PR is gated - coverage must meet the threshold to merge."
            exit 1
          else
            echo "✅ Coverage threshold met - PR gate passed!"
            echo "Coverage: ${COVERAGE}% meets threshold: ${THRESHOLD}%"
          fi

      - name: Report coverage status (direct pushes)
        if: always() && github.event_name == 'push' && steps.difftron.outcome != 'skipped'
        run: |
          # For direct pushes, just report - don't gate
          if [ -f analysis.json ]; then
            MEETS_THRESHOLD=$(jq -r '.meets_threshold // false' analysis.json 2>/dev/null || echo "false")
            COVERAGE=$(jq -r '.coverage_percentage // 0' analysis.json 2>/dev/null || echo "0")
            THRESHOLD=$(jq -r '.threshold // 80' analysis.json 2>/dev/null || echo "80")
            
            echo "Coverage: ${COVERAGE}% | Threshold: ${THRESHOLD}%"
            
            if [ "$MEETS_THRESHOLD" != "true" ]; then
              echo "⚠️  Coverage below threshold (${COVERAGE}% < ${THRESHOLD}%)"
              echo "Note: Direct pushes to main are not gated, but consider improving coverage."
            else
              echo "✅ Coverage meets threshold!"
            fi
          else
            echo "⚠️  Could not read analysis results"
          fi

      - name: Upload coverage artifact
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ github.run_number }}
          path: |
            coverage.out
            analysis.json
          retention-days: 7
          if-no-files-found: ignore
